---
- hosts: all
  become: yes
  tasks:
    - set_fact:
        dhis2versionfull: "{{ dhis2_version|default('2.32.0')}}"
    - set_fact:
        dhis2versionmajor: "{{ dhis2versionfull|regex_replace('^(\\d+\\.\\d+).*$','\\1') }}"
    - set_fact:
        dhis2wardisturl: "https://releases.dhis2.org/{{ dhis2versionmajor }}/{{ dhis2versionfull }}/dhis.war"
- import_playbook: common.yml
- hosts: all
  become: yes
  tasks:
    # The ROOT webapp directory must exist before tomcat8 gets installed
    # or else the postinst script will put default files there.
    - file:
        state: directory
        path: /var/lib/tomcat8/webapps/ROOT
    - package:
        state: present
        name:
          - tomcat8
          - unzip
    # The unarchive module uses unzip for war files
    - unarchive:
        remote_src: yes
        src: "{{ dhis2wardisturl }}"
        dest: /var/lib/tomcat8/webapps/ROOT

# TODO:
# - register tomcat as service
# - import Sierra Leone data
# - configure Google service account
# - ???

# Start with Ubuntu minimal (ubuntu-minimal/images/hvm-ssd/ubuntu-bionic-18.04-amd64-minimal-20190514)
# (Maybe?) Add "don't start services" /usr/sbin/policy-rc.d (exit 101)
# apt get update && apt get upgrade
# Install packages
# Add haproxy configuration file, reverse proxy to tomcat
# Add dhis2 war file
# Add sample data file
# Add dhis2 config file
# Add database role
# Add database
# Import sample data
# Add firstboot script
# - Regenerate snakeoil cert
# - Generate random database password
# - Generate random encryption password
# - Change database password
# - Update dhis2 config file
