---
- hosts: all
  tags: ["database"]
  become: true
  tasks:
    - set_fact:
        pypkgfam: "python{{ ansible_python.version.major|replace('2','') }}"
        dhisdbname: dhis2
        dhisdbuser: dhis
    - package:
        state: present
        name:
          - postgresql-10
          - postgresql-contrib-10
          - postgresql-10-postgis-2.4
          - "{{ pypkgfam }}-psycopg2"
    - service:
        name: postgresql
        state: started
    - wait_for:
        state: started
        port: 5432
    - block:
        - postgresql_user:
            state: present
            name: "{{ dhisdbuser }}"
            role_attr_flags: NOCREATEDB,NOCREATEROLE,LOGIN,NOSUPERUSER
            encrypted: yes
        - postgresql_db:
            state: present
            name: "{{ dhisdbname }}"
            owner: "{{ dhisdbuser }}"
        - postgresql_ext:
            state: present
            db: "{{ dhisdbname }}"
            name: postgis
      become_user: postgres
